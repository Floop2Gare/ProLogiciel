#!/bin/bash

# ========================================
#    ERPNext Mac Installer
#    Application graphique pour Mac
# ========================================

# Variables
APP_NAME="ERPNext"
INSTALL_DIR="$HOME/ERPNext"
DESKTOP_DIR="$HOME/Desktop"

# Fonction pour afficher des dialogues
show_dialog() {
    osascript -e "display dialog \"$1\" buttons {\"OK\"} default button \"OK\""
}

show_confirm() {
    osascript -e "display dialog \"$1\" buttons {\"Oui\", \"Non\"} default button \"Oui\""
}

# Fonction pour vÃ©rifier les permissions
check_permissions() {
    # VÃ©rifier si on peut Ã©crire dans le rÃ©pertoire home
    if [ ! -w "$HOME" ]; then
        show_dialog "Erreur : Pas de permissions d'Ã©criture dans le rÃ©pertoire utilisateur"
        exit 1
    fi
}

# Fonction pour installer Homebrew
install_homebrew() {
    show_dialog "Installation de Homebrew (gestionnaire de paquets Mac)..."
    
    if ! command -v brew &> /dev/null; then
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        
        # Ajouter au PATH pour Apple Silicon
        if [[ $(uname -m) == "arm64" ]]; then
            echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
            eval "$(/opt/homebrew/bin/brew shellenv)"
        fi
    fi
}

# Fonction pour installer les dÃ©pendances
install_dependencies() {
    show_dialog "Installation des dÃ©pendances (Python, Node.js, MariaDB)..."
    
    # Python 3.11
    brew install python@3.11
    
    # Node.js
    brew install node
    
    # Git
    brew install git
    
    # MariaDB
    brew install mariadb
    
    # Redis
    brew install redis
}

# Fonction pour configurer la base de donnÃ©es
setup_database() {
    show_dialog "Configuration de la base de donnÃ©es..."
    
    # DÃ©marrer MariaDB
    brew services start mariadb
    sleep 3
    
    # Configurer la base de donnÃ©es
    mysql -u root -e "CREATE DATABASE IF NOT EXISTS erpnext;"
    mysql -u root -e "CREATE USER IF NOT EXISTS 'erpnext'@'localhost' IDENTIFIED BY 'admin';"
    mysql -u root -e "GRANT ALL PRIVILEGES ON erpnext.* TO 'erpnext'@'localhost';"
    mysql -u root -e "FLUSH PRIVILEGES;"
}

# Fonction pour installer ERPNext
install_erpnext() {
    show_dialog "Installation d'ERPNext..."
    
    # CrÃ©er le rÃ©pertoire
    mkdir -p "$INSTALL_DIR"
    cd "$INSTALL_DIR"
    
    # Installer frappe-bench
    pip3 install frappe-bench
    
    # Initialiser frappe-bench
    bench init frappe-bench --frappe-branch version-15 --python python3.11
    
    cd frappe-bench
    
    # Installer ERPNext
    bench get-app erpnext --branch version-15
    
    # CrÃ©er le site
    bench new-site erpnext.localhost --admin-password admin --db-root-password admin --mariadb-root-password admin
    
    # Installer ERPNext sur le site
    bench --site erpnext.localhost install-app erpnext
}

# Fonction pour crÃ©er les scripts
create_scripts() {
    show_dialog "CrÃ©ation des scripts de dÃ©marrage..."
    
    # Script de dÃ©marrage
    cat > "$INSTALL_DIR/start-erpnext.sh" << 'EOF'
#!/bin/bash
echo "ðŸš€ DÃ©marrage d'ERPNext..."

# DÃ©marrer les services
brew services start mariadb
brew services start redis

# Attendre
sleep 3

# DÃ©marrer ERPNext
cd ~/ERPNext/frappe-bench
bench start
EOF

    # Script d'arrÃªt
    cat > "$INSTALL_DIR/stop-erpnext.sh" << 'EOF'
#!/bin/bash
echo "ðŸ›‘ ArrÃªt d'ERPNext..."

# ArrÃªter les services
brew services stop mariadb
brew services stop redis

echo "âœ… ERPNext arrÃªtÃ© !"
EOF

    # Rendre exÃ©cutables
    chmod +x "$INSTALL_DIR/start-erpnext.sh"
    chmod +x "$INSTALL_DIR/stop-erpnext.sh"
}

# Fonction pour crÃ©er le raccourci
create_shortcut() {
    show_dialog "CrÃ©ation du raccourci sur le Bureau..."
    
    # Raccourci sur le Bureau
    cat > "$DESKTOP_DIR/ERPNext.command" << 'EOF'
#!/bin/bash
cd ~/ERPNext
./start-erpnext.sh
EOF
    
    chmod +x "$DESKTOP_DIR/ERPNext.command"
}

# Fonction principale
main() {
    # VÃ©rifier les permissions
    check_permissions
    
    # Demander confirmation
    if ! show_confirm "Installer ERPNext sur ce Mac ?\n\nCela va installer :\n- Homebrew\n- Python 3.11\n- Node.js\n- MariaDB\n- Redis\n\nContinuer ?"; then
        show_dialog "Installation annulÃ©e"
        exit 0
    fi
    
    # Installation
    install_homebrew
    install_dependencies
    setup_database
    install_erpnext
    create_scripts
    create_shortcut
    
    # Message de fin
    show_dialog "ðŸŽ‰ Installation terminÃ©e !\n\nERPNext est maintenant installÃ©.\n\nPour dÃ©marrer :\n- Double-cliquez sur 'ERPNext.command' sur le Bureau\n- Ou exÃ©cutez : cd ~/ERPNext && ./start-erpnext.sh\n\nURL : http://localhost:8000\nUtilisateur : Administrator\nMot de passe : admin"
    
    # Proposer de dÃ©marrer
    if show_confirm "Voulez-vous dÃ©marrer ERPNext maintenant ?"; then
        cd "$INSTALL_DIR"
        ./start-erpnext.sh
    fi
}

# ExÃ©cuter le script principal
main
